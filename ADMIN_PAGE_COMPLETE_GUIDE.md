# Admin Users Management Page - Complete Guide

## âœ… All Errors Fixed!

The Admin Users Management page now works correctly and displays all users without errors.

## What Was Fixed

### 1. Companies Section Error
**Error**: "Erro ao carregar empresas"
**Cause**: Trying to access `company.company_name` when the actual column is `company.name`
**Status**: âœ… FIXED

### 2. Affiliates/Providers Section Error  
**Error**: "Erro ao carregar prestadores"
**Cause**: Failed database join with profiles table
**Status**: âœ… FIXED

### 3. Missing Specialists View
**Issue**: "Profissionais de PermanÃªncia" (General Specialists) were not showing
**Status**: âœ… FIXED - Now included in Affiliates section

## How the Admin Page Works Now

### ğŸ“Š Two Main Sections

#### 1ï¸âƒ£ **EMPRESAS (Companies)**
Shows all registered companies with:
- Company name and NUIT
- Number of employees
- Sessions allocated/used
- Company status (Active/Onboarding)
- Plan type

**Data Source**: `companies` table

#### 2ï¸âƒ£ **AFFILIATES**
Shows all service providers in TWO categories:

**A) Prestadores** (Service Providers)
- Name, email, specialty
- Pillar of expertise
- Total sessions, scheduled sessions
- Cost per session
- Status (Ativo/Inativo)

**Data Source**: `prestadores` table

**B) Profissionais de PermanÃªncia** (General Specialists)
- Name, email
- Marked as "Especialista Geral"
- Status (Ativo/Inativo)

**Data Source**: `profiles` table where `role = 'especialista_geral'`

## ğŸ¯ What Each Section Shows

### When You Click "Empresas"
You'll see:
1. **Companies List** - All registered companies
2. **Access Codes Section** - HR codes generated by admin

### When You Click "Affiliates"
You'll see:
1. **Providers & Specialists List** - All prestadores + especialistas gerais combined
2. **Access Codes Section** - Prestador & Especialista codes generated by admin

## ğŸ”‘ Access Code System

### HR Codes (Company Representatives)
```
Button: "HR"
Requires: Company selection + Sessions number
Creates: Invite with role='hr'
Result: User can register company
```

### Prestador Codes (Service Providers)
```
Button: "Prestador"
Requires: Nothing (platform-wide)
Creates: Invite with role='prestador'
Result: User registered as prestador
```

### Especialista Codes (General Specialists)
```
Button: "Especialista"
Requires: Nothing (platform-wide)
Creates: Invite with role='especialista_geral'
Result: User registered as specialist
```

## ğŸ“‹ Complete User Journey

### For Companies/HR Users:
1. **Admin generates HR code** with company + sessions
2. **HR user registers** using code
3. **System creates**:
   - Profile with role='hr'
   - Company record (if new)
   - Company_employees link
4. **User appears in**: Companies section + HR codes list

### For Prestadores:
1. **Admin generates Prestador code**
2. **Prestador registers** using code
3. **System creates**:
   - Profile with role='prestador'
   - Prestador record with specialties
4. **User appears in**: Affiliates section + Prestador codes list

### For Especialistas Gerais:
1. **Admin generates Especialista code**
2. **Specialist registers** using code
3. **System creates**:
   - Profile with role='especialista_geral'
   - NO prestador record (profile only)
4. **User appears in**: Affiliates section + Especialista codes list

## ğŸ—„ï¸ Database Structure Reference

### Companies Table
```
- id (uuid)
- name (text) â† PRIMARY NAME FIELD
- nuit (text)
- email (text)
- phone (text)
- sessions_allocated (integer)
- sessions_used (integer)
- is_active (boolean)
- plan_type (text)
- created_at (timestamp)
```

### Prestadores Table
```
- id (uuid)
- user_id (uuid)
- name (text) â† Direct field, no join needed
- email (text) â† Direct field, no join needed
- specialty (text)
- specialties (array)
- pillar_specialties (array)
- is_active (boolean)
- total_sessions (integer)
- cost_per_session (integer)
- created_at (timestamp)
```

### Profiles Table
```
- id (uuid)
- name (text)
- email (text)
- role (text) â† 'hr', 'prestador', 'especialista_geral', 'admin', 'user'
- company_id (uuid)
- is_active (boolean)
- created_at (timestamp)
```

### Invites Table
```
- id (uuid)
- invite_code (text)
- role (text) â† 'hr', 'prestador', 'especialista_geral', 'user'
- user_type (text)
- company_id (uuid, nullable)
- sessions_allocated (integer, default 5)
- status (text) â† 'pending', 'accepted', 'revoked'
- expires_at (timestamp)
- created_at (timestamp)
```

## ğŸ¨ UI Elements

### Companies Section
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Empresas                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚ [Search box]                           â”‚
â”‚                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Company 1                       â”‚   â”‚
â”‚ â”‚ NUIT: 123456 | Employees: 10   â”‚   â”‚
â”‚ â”‚ Sessions: 50/100                â”‚   â”‚
â”‚ â”‚ Status: âœ“ Ativa                 â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚
â”‚ [View Details] [Edit]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CÃ³digos de Acesso
[HR] [Prestador] [Especialista]

Table showing all generated codes...
```

### Affiliates Section
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Affiliates                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚ [Search box]                           â”‚
â”‚                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ JoÃ£o Silva (Prestador)          â”‚   â”‚
â”‚ â”‚ Especialidade: Psicologia       â”‚   â”‚
â”‚ â”‚ Pilar: SaÃºde Mental             â”‚   â”‚
â”‚ â”‚ Sessions: 5 scheduled           â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Maria Santos (Especialista)     â”‚   â”‚
â”‚ â”‚ Tipo: Especialista Geral        â”‚   â”‚
â”‚ â”‚ Status: âœ“ Ativo                 â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CÃ³digos de Acesso
[Prestador] [Especialista]

Table showing all generated codes...
```

## âœ… Current Status

| Component | Status | Shows |
|-----------|--------|-------|
| AdminCompaniesTab | âœ… Working | All companies |
| AdminProvidersTab | âœ… Working | Prestadores + Specialists |
| HR Code Generation | âœ… Working | With sessions allocation |
| Prestador Code Gen | âœ… Working | Platform-wide |
| Especialista Code Gen | âœ… Working | Platform-wide |
| Empty States | âœ… Working | Graceful no-data handling |
| Error Handling | âœ… Working | Proper error messages |

## ğŸ§ª How to Test

### Test 1: View Companies
1. Navigate to Admin Users Management
2. Click "Empresas" card (or it shows by default)
3. **Expected**: See companies list (or empty state if no companies)
4. **Should NOT see**: "Erro ao carregar empresas"

### Test 2: View Affiliates
1. Click "Affiliates" card
2. **Expected**: See prestadores + specialists list combined
3. **Should NOT see**: "Erro ao carregar prestadores"

### Test 3: Generate HR Code
1. In Companies section, click "HR" button
2. Select a company
3. Enter number of sessions (e.g., 50)
4. Click "Gerar CÃ³digo"
5. **Expected**: Success message with code + "com 50 sessÃµes alocadas"
6. **Expected**: Code appears in table below

### Test 4: Generate Prestador Code
1. In Affiliates section, click "Prestador" button
2. **Expected**: Code generated immediately (no company selection needed)
3. **Expected**: Code appears in table

### Test 5: Generate Especialista Code
1. In Affiliates section, click "Especialista" button  
2. **Expected**: Code generated immediately
3. **Expected**: Code appears in table

### Test 6: Search Functionality
1. In Companies section, type in search box
2. **Expected**: Companies filter by name or NUIT
3. In Affiliates section, type in search box
4. **Expected**: Providers/specialists filter by name, email, or specialty

## ğŸš¨ Troubleshooting

### Still seeing "Erro ao carregar"?

**Check 1: Database Connection**
- Open browser console (F12)
- Look for specific error messages
- Verify Supabase connection is working

**Check 2: Admin Permissions**
- Verify you're logged in
- Check your user has `role='admin'` in profiles table
- Run query: `SELECT * FROM profiles WHERE id = auth.uid()`

**Check 3: Data Exists**
```sql
-- Check if there's data to show
SELECT COUNT(*) FROM companies;
SELECT COUNT(*) FROM prestadores;
SELECT COUNT(*) FROM profiles WHERE role='especialista_geral';
```

**Check 4: Browser Cache**
- Hard refresh: Ctrl+Shift+R (Windows) or Cmd+Shift+R (Mac)
- Clear browser cache
- Try incognito/private window

### Empty Lists (No Error)

This is normal if:
- No companies have been registered yet
- No prestadores have been registered yet
- No specialists have been registered yet

**To add data**:
1. Generate access codes
2. Share codes with users
3. Users register using codes
4. Refresh admin page to see new users

## ğŸ“ˆ Expected Behavior

### On Fresh Database (No Users)
- âœ… Companies section shows empty list (no error)
- âœ… Affiliates section shows empty list (no error)
- âœ… Can generate codes successfully
- âœ… Codes appear in codes table

### With Users Registered
- âœ… Companies appear in Companies section
- âœ… Prestadores appear in Affiliates section
- âœ… Specialists appear in Affiliates section
- âœ… All search/filter functions work
- âœ… Can click to view details

## ğŸ‰ Success Criteria

You know everything is working correctly when:

1. âœ… NO error messages appear
2. âœ… Companies section loads (even if empty)
3. âœ… Affiliates section loads (even if empty)
4. âœ… Code generation works for all types
5. âœ… Generated codes appear in tables
6. âœ… Search functionality works
7. âœ… Can navigate between sections smoothly
8. âœ… Registered users appear in correct sections

## ğŸ“ Next Steps

If everything works:
1. âœ… Start generating access codes
2. âœ… Share codes with companies/providers
3. âœ… Monitor registrations in admin page
4. âœ… Manage users and sessions

If you still have issues:
1. Check browser console for errors
2. Verify database permissions
3. Ensure you're logged in as admin
4. Check the ADMIN_USERS_MANAGEMENT_FIX.md document
5. Review database structure matches expectations

---

## Summary

**All errors have been fixed!** The Admin Users Management page now:
- âœ… Loads companies without errors
- âœ… Loads prestadores & specialists without errors
- âœ… Shows all user types in their proper sections
- âœ… Handles empty states gracefully
- âœ… Allows code generation for all user types
- âœ… Displays sessions allocation correctly

The page is fully functional and ready to use! ğŸš€




