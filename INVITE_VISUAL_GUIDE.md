# Invite-by-Code System - Visual Architecture Guide

## System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         COMPANY COLLABORATORS PAGE                           â”‚
â”‚                    (/company/colaboradores)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚    Code Generation Section   â”‚   â”‚   Code Redemption Section    â”‚        â”‚
â”‚  â”‚                              â”‚   â”‚                              â”‚        â”‚
â”‚  â”‚ "Gerar CÃ³digo de Acesso"     â”‚   â”‚ "Usar CÃ³digo de Convite"     â”‚        â”‚
â”‚  â”‚ [Generate Button]            â”‚   â”‚ [Toggle Button]              â”‚        â”‚
â”‚  â”‚                              â”‚   â”‚   â†“                          â”‚        â”‚
â”‚  â”‚ - Generate random code       â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚        â”‚
â”‚  â”‚ - Save to invites table      â”‚   â”‚ â”‚ InviteRedemption      â”‚   â”‚        â”‚
â”‚  â”‚ - Show in list               â”‚   â”‚ â”‚ Component             â”‚   â”‚        â”‚
â”‚  â”‚ - Allow copy/download        â”‚   â”‚ â”‚                        â”‚   â”‚        â”‚
â”‚  â”‚                              â”‚   â”‚ â”‚ Input: invite_code   â”‚   â”‚        â”‚
â”‚  â”‚                              â”‚   â”‚ â”‚ Button: Redeem       â”‚   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚        â”‚
â”‚                                      â”‚                              â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
                                       â”‚
                                       â”‚ POST to Edge Function
                                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  EDGE FUNCTION: invite-redeem                                â”‚
â”‚           supabase/functions/invite-redeem/index.ts                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  1. Validate Auth Token                                                      â”‚
â”‚     âœ… Check Authorization header present                                    â”‚
â”‚     âœ… Extract & verify bearer token                                         â”‚
â”‚     âœ… Get authenticated user                                                â”‚
â”‚                                                                               â”‚
â”‚  2. Find Invite                                                              â”‚
â”‚     âœ… Query invites table by code                                           â”‚
â”‚     âœ… Verify record exists                                                  â”‚
â”‚     âœ… Load company relationship                                             â”‚
â”‚                                                                               â”‚
â”‚  3. Validate Invite Status                                                   â”‚
â”‚     âœ… Check status = 'pending'                                              â”‚
â”‚     âœ… Check not yet expired                                                 â”‚
â”‚     âœ… Verify user not already member                                        â”‚
â”‚                                                                               â”‚
â”‚  4. CREATE company_employees Record                                          â”‚
â”‚     âœ… user_id = authenticated user                                          â”‚
â”‚     âœ… company_id = from invite                                              â”‚
â”‚     âœ… is_active = true                                                      â”‚
â”‚     âœ… joined_at = now()                                                     â”‚
â”‚                                                                               â”‚
â”‚  5. INSERT user_roles Record                                                 â”‚
â”‚     âœ… role = 'user'                                                         â”‚
â”‚     âœ… Skip if already exists                                                â”‚
â”‚                                                                               â”‚
â”‚  6. UPDATE invites Record                                                    â”‚
â”‚     âœ… status = 'accepted'                                                   â”‚
â”‚     âœ… accepted_at = now()                                                   â”‚
â”‚     âœ… email = user's email                                                  â”‚
â”‚                                                                               â”‚
â”‚  7. UPDATE profiles Record                                                   â”‚
â”‚     âœ… company_id = from invite                                              â”‚
â”‚     âœ… User now linked to company                                            â”‚
â”‚                                                                               â”‚
â”‚  8. Return Success                                                           â”‚
â”‚     âœ… company_id for redirect                                               â”‚
â”‚     âœ… company_name for display                                              â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â”‚ Response
                                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FRONTEND: InviteRedemption Component                             â”‚
â”‚           src/components/company/InviteRedemption.tsx                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  On Success:                                                                 â”‚
â”‚  âœ… Show green success card                                                  â”‚
â”‚  âœ… Display "VocÃª foi adicionado a {company_name}!"                          â”‚
â”‚  âœ… Show CheckCircle icon                                                    â”‚
â”‚  âœ… Wait 2 seconds                                                           â”‚
â”‚  âœ… Redirect to /company/dashboard                                           â”‚
â”‚                                                                               â”‚
â”‚  On Error:                                                                   â”‚
â”‚  âŒ Show error toast message                                                 â”‚
â”‚  âŒ Keep form visible                                                        â”‚
â”‚  âŒ Allow retry                                                              â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Database Schema - Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           auth.users                  â”‚
â”‚                                      â”‚
â”‚ id (UUID)                           â”‚
â”‚ email                               â”‚
â”‚ created_at                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ 1:1
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          profiles                     â”‚         â”‚       company_employees             â”‚
â”‚                                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                      â”‚
â”‚ id (user_id)                         â”‚  N:1    â”‚ id                                   â”‚
â”‚ company_id â† SET BY INVITE           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚ user_id (FK â†’ profiles.id)          â”‚
â”‚ name                                 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚ company_id (FK â†’ companies.id)      â”‚
â”‚ email                                â”‚         â”‚ is_active = true                    â”‚
â”‚ avatar_url                           â”‚         â”‚ joined_at (set at redemption)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚
               â”‚ 1:N
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        user_roles                     â”‚
â”‚                                      â”‚
â”‚ id                                   â”‚
â”‚ user_id (FK â†’ profiles.id)          â”‚
â”‚ role = 'user' (set at redemption)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      invites (Temporary)              â”‚
â”‚                                      â”‚
â”‚ id                                   â”‚
â”‚ invite_code (UNIQUE)                â”‚
â”‚ company_id (FK â†’ companies.id)      â”‚
â”‚ status: 'pending' â†’ 'accepted'      â”‚
â”‚ expires_at (7 days)                 â”‚
â”‚ created_at                          â”‚
â”‚ accepted_at (â† set at redemption)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ N:1
          â”‚
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        companies                      â”‚
â”‚                                      â”‚
â”‚ id (UUID)                           â”‚
â”‚ company_name                        â”‚
â”‚ created_at                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow - State Transitions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  INITIAL STATE (Before Redemption)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚ profiles:                           â”‚
â”‚   â”œâ”€ id: user-123                  â”‚
â”‚   â”œâ”€ company_id: NULL              â”‚ â† Not yet linked
â”‚   â””â”€ name: "JoÃ£o Silva"            â”‚
â”‚                                     â”‚
â”‚ user_roles:                         â”‚
â”‚   â”œâ”€ user_id: user-123             â”‚
â”‚   â””â”€ role: 'user'                  â”‚
â”‚                                     â”‚
â”‚ company_employees:                  â”‚
â”‚   â””â”€ (no record for user-123)       â”‚ â† Not a member yet
â”‚                                     â”‚
â”‚ invites:                            â”‚
â”‚   â”œâ”€ invite_code: MS-ABC123        â”‚
â”‚   â”œâ”€ status: pending               â”‚ â† Waiting to be used
â”‚   â”œâ”€ company_id: company-456       â”‚
â”‚   â””â”€ expires_at: 2025-11-09        â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ User clicks "Resgatar"
              â”‚ Enters MS-ABC123
              â”‚
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FINAL STATE (After Redemption)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚ profiles:                           â”‚
â”‚   â”œâ”€ id: user-123                  â”‚
â”‚   â”œâ”€ company_id: company-456       â”‚ â† âœ… NOW LINKED!
â”‚   â””â”€ name: "JoÃ£o Silva"            â”‚
â”‚                                     â”‚
â”‚ user_roles:                         â”‚
â”‚   â”œâ”€ user_id: user-123             â”‚
â”‚   â””â”€ role: 'user'                  â”‚
â”‚                                     â”‚
â”‚ company_employees: (NEW)            â”‚
â”‚   â”œâ”€ user_id: user-123             â”‚ â† âœ… NEW MEMBER!
â”‚   â”œâ”€ company_id: company-456       â”‚
â”‚   â”œâ”€ is_active: true               â”‚
â”‚   â”œâ”€ joined_at: 2025-11-02 14:30  â”‚
â”‚   â””â”€ sessions_allocated: 10        â”‚
â”‚                                     â”‚
â”‚ invites:                            â”‚
â”‚   â”œâ”€ invite_code: MS-ABC123        â”‚
â”‚   â”œâ”€ status: accepted              â”‚ â† âœ… USED!
â”‚   â”œâ”€ company_id: company-456       â”‚
â”‚   â”œâ”€ accepted_at: 2025-11-02 14:30â”‚ â† âœ… TIMESTAMP!
â”‚   â”œâ”€ email: joao@company.com       â”‚ â† âœ… RECORDED!
â”‚   â””â”€ expires_at: 2025-11-09        â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ Success message shown
              â”‚ Auto-redirect to dashboard
              â”‚ User now sees company content
              â”‚
              â†“
         âœ… SUCCESS!
```

---

## Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CLIENT SIDE VALIDATION                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Code format check (not empty)                         â”‚
â”‚ âœ“ Auto-uppercase input                                  â”‚
â”‚ âœ“ Disable button during loading                         â”‚
â”‚ âœ“ Error message display                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           TRANSPORT LAYER SECURITY                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ HTTPS only (enforced by Supabase)                     â”‚
â”‚ âœ“ Bearer token in Authorization header                  â”‚
â”‚ âœ“ Content-Type: application/json                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        AUTHENTICATION LAYER (Edge Function)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Verify Authorization header present                   â”‚
â”‚ âœ“ Extract bearer token                                  â”‚
â”‚ âœ“ Call supabase.auth.getUser(token)                     â”‚
â”‚ âœ“ Verify user exists and is authenticated               â”‚
â”‚ âœ“ Return 401 if invalid                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          BUSINESS LOGIC VALIDATION                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Check invite code exists (404 if not)                 â”‚
â”‚ âœ“ Check status = pending (400 if not)                   â”‚
â”‚ âœ“ Check not expired (400 if expired)                    â”‚
â”‚ âœ“ Check user not already member (400 if yes)            â”‚
â”‚ âœ“ All validations before any INSERT/UPDATE              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          DATABASE ACCESS CONTROL (RLS)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Edge Function uses service_role key                   â”‚
â”‚ âœ“ Bypasses RLS but still validated above                â”‚
â”‚ âœ“ All tables have RLS enabled                           â”‚
â”‚ âœ“ Regular users can't bypass these checks               â”‚
â”‚ âœ“ Audit trail in database for all operations            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          DATA INTEGRITY CONSTRAINTS                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Invite code UNIQUE (can't duplicate)                  â”‚
â”‚ âœ“ User + Company unique in company_employees            â”‚
â”‚ âœ“ Foreign key references maintained                     â”‚
â”‚ âœ“ Status enum (only valid values)                       â”‚
â”‚ âœ“ Timestamps immutable (once set)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User Enters Code & Submits    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ No Token?           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ YES
             â†“
    âŒ 401: Not Authenticated
    Show: "VocÃª nÃ£o estÃ¡ autenticado"


             â”‚ NO
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Code Exists?        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
       NO â”€â”€â”€â”¼â”€â”€â”€ YES
             â”‚      â”‚
             â†“      â†“
        âŒ 404   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        "Invite â”‚ Status = Pending?   â”‚
         code   â”‚                     â”‚
         not    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         found"         â”‚
                   NO â”€â”€â”¼â”€â”€ YES
                        â”‚     â”‚
                        â†“     â†“
                   âŒ 400  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   "Invite â”‚ Not Expired?        â”‚
                    is     â”‚                     â”‚
                    {stat  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    us}"           â”‚
                              NO â”€â”€â”¼â”€â”€ YES
                                   â”‚     â”‚
                                   â†“     â†“
                              âŒ 400  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              "Invite â”‚ User Already        â”‚
                               has    â”‚ Member?             â”‚
                               expir  â”‚                     â”‚
                               ed"    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                         NO â”€â”€â”¼â”€â”€ YES
                                             â”‚     â”‚
                                             â†“     â†“
                                        âœ… OK  âŒ 400
                                             â”‚   "Already
                                             â”‚    part"
                                             â”‚
                                             â†“
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ All Checks Pass  â”‚
                                  â”‚                  â”‚
                                  â”‚ Create:          â”‚
                                  â”‚ - Employee       â”‚
                                  â”‚ - Role           â”‚
                                  â”‚ - Update Invite  â”‚
                                  â”‚ - Update Profile â”‚
                                  â”‚                  â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â†“
                                    âœ… 200 Success
                                    
                                    Return:
                                    - company_id
                                    - company_name
                                    - Success message
```

---

## File Organization

```
src/
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ CompanyCollaborators.tsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Main page
â”‚       â”œâ”€â”€ Import InviteRedemption
â”‚       â”œâ”€â”€ State: showInviteRedemption
â”‚       â””â”€â”€ Render: Toggle + Component
â”‚
â””â”€â”€ components/
    â””â”€â”€ company/
        â””â”€â”€ InviteRedemption.tsx â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Redemption UI
            â”œâ”€â”€ State: inviteCode, loading
            â”œâ”€â”€ Handle: Redeem, KeyPress
            â”œâ”€â”€ Show: Input, Button
            â””â”€â”€ Display: Success/Error

supabase/
â””â”€â”€ functions/
    â””â”€â”€ invite-redeem/
        â””â”€â”€ index.ts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Edge Function
            â”œâ”€â”€ POST request handler
            â”œâ”€â”€ Auth token validation
            â”œâ”€â”€ DB operations (5 steps)
            â””â”€â”€ Response handling
```

---

**Ready to deploy!** ğŸš€
